volumes:
  pgdata:

services:
  # -------- database
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB:       ${POSTGRES_DB}
      POSTGRES_USER:     ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD", "pg_isready", "-U", "postgres" ]
      interval: 3s
      timeout: 3s
      retries: 10

  # -------- cache / queue
  redis:
    image: redis:7-alpine
    restart: unless-stopped

  # -------- api-gateway
  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    env_file:
      - ./.env
    environment:
      MODEL_QUEUE_KOKORO: tts:kokoro
    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
    restart: unless-stopped
    expose: ["8000"]

  # -------- kokoro workers for local model serving
  kokoro-cpu:
    profiles:
      - self-host
    build:
      context: .
      dockerfile: workers/kokoro/Dockerfile.cpu
    env_file: ./.env
    environment:
      MODEL_QUEUE:  tts:kokoro
      DEVICE:       cpu
      WORKER_CONCURRENCY: 2
    depends_on: [redis]
    restart: unless-stopped

  kokoro-gpu:
    profiles:
      - self-host
    build:
      context: .
      dockerfile: workers/kokoro/Dockerfile.gpu
    env_file: ./.env
    environment:
      MODEL_QUEUE:  tts:kokoro
      DEVICE:       cuda
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              capabilities: [gpu]
    depends_on: [redis]
    restart: unless-stopped
