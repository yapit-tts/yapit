volumes:
  pgdata:

services:
  # -------- database
  postgres:
    init: true
    image: postgres:16-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-yapit}"]
      start_period: 30s
      start_interval: 1s
      interval: 30s
      timeout: 3s
      retries: 10

  # -------- cache / queue
  redis:
    init: true
    image: redis:7-alpine
    restart: unless-stopped

  # -------- api-gateway
  gateway:
    init: true
    build:
      context: .
      dockerfile: yapit/gateway/Dockerfile
    env_file:
      - ./.env.prod
    environment:
      ENV_FILE: .env.prod
    depends_on:
      redis:
        condition: service_started
      postgres:
        condition: service_healthy
      stack-auth:
        condition: service_started
    restart: unless-stopped
    expose: ["8000"]
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()"]
      start_period: 60s
      start_interval: 1s
      interval: 30s
      timeout: 5s
      retries: 10

  # -------- auth
  stack-auth:
    build:
      dockerfile: ./docker/Dockerfile.stackauth
    restart: unless-stopped
    env_file: ./.env.prod
    healthcheck:
       test: ["CMD-SHELL",
         "curl -fs http://localhost:8101/health && \
          curl -fs http://localhost:8102/health"]
       start_period: 60s
       start_interval: 1s
       interval: 30s
       timeout: 5s
       retries: 10

  # svix:
  #   image: svix/svix-server
  #   restart: unless-stopped
  #   env_file: ./.env.prod

