upstream gateway {
    server gateway:8000;
    keepalive 64;
}

upstream stack_auth_api {
    server stack-auth:8102;
    keepalive 16;
}

upstream stack_auth_dashboard {
    server stack-auth:8101;
    keepalive 8;
}

# WebSocket upgrade: set Connection "upgrade" only when Upgrade header is present,
# otherwise empty string for HTTP/1.1 keepalive
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      '';
}

server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;
    server_tokens off;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Max upload size (aligned with backend's document_max_download_size)
    client_max_body_size 100M;

    # API proxy â€” keepalive for HTTP, upgrade for WebSocket
    location /api/ {
        proxy_pass http://gateway/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_connect_timeout 75s;
    }

    # Stack Auth API proxy (must come before /auth/ to match first)
    # Own add_header block prevents inheriting X-Frame-Options DENY from server level
    # (Stack Auth dashboard may use iframes). Stack Auth sets its own headers too.
    location /auth/api/ {
        proxy_pass http://stack_auth_api/api/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    }

    # Stack Auth Dashboard proxy
    location /auth/ {
        proxy_pass http://stack_auth_dashboard/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    }

    # Social bot detection for /listen/* routes (og:image previews)
    location ~ ^/listen/([^/]+)$ {
        # Rewrite to og-preview endpoint for social bots
        if ($http_user_agent ~* "twitterbot|facebookexternalhit|discordbot|slackbot|linkedinbot|telegrambot|whatsapp") {
            rewrite ^/listen/(.+)$ /api/v1/documents/$1/og-preview last;
        }
        # Regular browsers get the SPA
        try_files $uri /index.html;
    }

    # SPA fallback - serve index.html for all other routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Prevent caching of index.html (so users get new JS/CSS after deploys)
    # NOTE: nginx doesn't inherit server-level add_header into blocks with their own,
    # so security headers must be repeated here and in the static assets block.
    location = /index.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    }

    # Cache static assets
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    }
}
